<?xml version="1.0" encoding="UTF-8"?>
<gate>
	<name>Megafon</name>
	<caption>Мегафон</caption>
	<type>SMS</type>
	<class>HTTP</class>
	<version>22</version>
	<priority>10</priority>
	<country>Россия</country>
	<prefixlist>
		<prefix start="+7 920" end="+7 933"/>
		<prefix start="+7 937" end="+7 938"/>
		<prefix start="+7 939 70" end="+7 939 75"/>

		<prefix start="+7 812 90" end="+7 812 91" tag="1"/>
		<prefix start="+7 812 93" end="+7 812 96" tag="1"/>
		<prefix start="+7 812 99" tag="1"/>

		<prefix start="7 495 500" end="7 495 507" tag="0"/>
		<prefix start="7 495 51" tag="0"/>
		<prefix start="7 495 542" end="+7 495 543" tag="0"/>
		<prefix start="7 495 771" end="7 495 772" tag="0"/>
		
	</prefixlist>
	<info>
		<maxsymbols>150</maxsymbols>
		<maxunicodesymbols>150</maxunicodesymbols>
		<supportflash>0</supportflash>
		<supportdtdelivery>1</supportdtdelivery>
		<supportunicode>1</supportunicode>
		<captcha>1</captcha>
		<supportcheckdelivery>0</supportcheckdelivery>
		<gateurl>http://moscow.megafon.ru/help/info/message/</gateurl>
	</info>
	<classprops>
		<encoding>UTF-8</encoding>
		<pageurl>http://moscow.megafon.ru/help/info/message/</pageurl>
		<imageurl>eval(
			begin
				HTTP.Referer := 'http://moscow.megafon.ru/help/info/message/';
				HTTP.Headers['X-Requested-With'] := 'XMLHttpRequest';
				PostData.Add('action', 'get_code');
				HTTP.HttpMethod('POST', 'http://moscow.megafon.ru/captcha/');
				Stored['Captcha_key'] := HTML.Text;
				Result := 'http://moscow.megafon.ru/captcha/' + Stored['Captcha_key'] + '/';
			end;)
		</imageurl>	
		<posturl>http://moscow.megafon.ru/sms.json</posturl>
		<postdata>eval(
			var
				DT: TDateTime;
			begin
				DT:=AdjustTimeZone(SMS['DeliveryTime'],180,true);
				PostData.Add('phone', '+7+' + SMS['Phone_Def'] + '+' + Copy(SMS['Phone_Number'], 1,3) + '+' + Copy(SMS['Phone_Number'], 4,2) + '+' + Copy(SMS['Phone_Number'], 6,2));
				PostData.Add('message',SMS['Text']);
				if SMS['Delivery'] then
				begin
					PostData.Add('shedule_date', FormatDateTime('dd.mm.yyyy',DT));
					PostData.Add('shedule_time', FormatDateTime('hh+++nn',DT));
				end else
					PostData.Add('shedule_date', '');
					PostData.Add('shedule_time', '');
				begin
				end;
				PostData.Add('__captcha[codekey]', Stored['Captcha_key']);
				PostData.Add('__captcha[codeval]', SMS['Code']);
				PostData.Add('action', 'sendsms');
			end;)
		</postdata>
		<success>eval(
			begin
				Result:=Html.ExistsStr('&quot;type&quot;:&quot;sms&quot;');
				Stored['cd_cookie_value'] := Html.Text;
			end;)
		</success>
		<error>eval(
			begin
				if Html.ExistsStr('captcha') then
					Result := 'Неправильно введены символы с картинки'
				else if Html.ExistsStr('phone') then
					Result := 'Некорректно введен номер телефона'
				else if Html.ExistsStr('message') then
					Result := 'Некорректно введено сообщение'
				else if Html.ExistsStr('server') then
					Result := 'Произошла ошибка на сервер оператора. Попробуйте позже.'
				else 
					Result := 'Неизвестная ошибка';
			end;)
		</error>
		<cd_method>POST</cd_method>
		<cd_posturl>http://moscow.megafon.ru/sms.json</cd_posturl>
		<cd_postdata>eval(
			begin
				Cookies['sendsms_uk'] := EncodeFormElemEx(Stored['cd_cookie_value'], NonAsciiChar + URLSpecialChar + URLFullSpecialChar + ',');
				PostData.Add('action', 'statussms');
			end;)
		</cd_postdata>
		<cd_success>eval(
			var
				Status: string;
			begin
				if not Html.ExistsStr('&quot;type&quot;:&quot;sms&quot;') then
					Result:=false
				else begin
					Status := Html.RegExp('&quot;status&quot;:&quot;(.*?)&quot;',1);
					if (Status = '') or (Status = '30') then
						Result:=true
					else	
						Result:='WAIT';
				end;	
			end;)
		</cd_success>
		<cd_error>eval(
			begin
				Result:='Ошибка при проверке подтверждения доставки';
			end;	
		</cd_error>
	</classprops>
</gate>